
/*
  For Arduino 
  (part of the Arduino starter kit tutorial)
  This program uses a servo-motor and a piezo 
  (a sensor that senses vibrations) in a box and a 
  switch and an LED,LEDs indicate if box is locked or unlocked.
  Knocks on the box opens the lock mechanism if certain vibration
  level is hit.
  
  by PJ Banerjee
*/


#include <Servo.h>

Servo myServo;

const int pinvar = A0;
const int switchPin = 2;
const int yellow = 3;
const int green = 4;
const int red = 5;

int knocks;
int knockVal;
int switchVal;
const int quietKnock = 10;
const int loudKnock = 100;

boolean locked = false;

int numberofKnocks=0;

void setup()
 {
   myServo.attach(9);
   pinMode(switchVal, INPUT);
   pinMode(yellow, OUTPUT);
   pinMode(red, OUTPUT);
   pinMode(green, OUTPUT);
   
   
   digitalWrite(green, HIGH);
   myServo.write(0);
   Serial.println("Unlocked");
 }
 
void loop()
 {
  if(locked==false)
   {
    switchVal = digitalRead(switchPin); 
   }
  if(switchVal==HIGH)
   {
    locked = true;
    digitalWrite(green, LOW);
    digitalWrite(red, HIGH);
    myServo.write(90);
    Serial.println("Locked");
    delay(1000);
   }
   if(locked == true)
    {
     knockVal = analogRead(pinvar);
    }
   if(knocks< 3 && knocks > 0)
    {
     if(checkForKnock(knockVal)==true)
       {
        knocks++;
       }
     Serial.print(3-knocks);
     Serial.println(" more knocks to go");
    }
  
   if(knocks == 3)
    {
     locked = false;
     myServo.write(0);
     delay(20);
     digitalWrite(green, HIGH);
     digitalWrite(red, LOW);
     Serial.println("Unlocked");
    }
   }

 
 boolean checkForKnock(int value)
  {
    if(value > quietKnock && value < loudKnock)
     {
       digitalWrite(yellow, HIGH);
       delay(50);
       digitalWrite(yellow, LOW);
       Serial.print("valid knock of value ");
       Serial.println(value);
   
       return true;
     } 
    else
     {
       Serial.print("Bad knock value :");
       Serial.println(value);
       return false; 
     }
  }
